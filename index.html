<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Scheduling Agent</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [query, setQuery] = React.useState('');
      const [response, setResponse] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState('');

      // Function to stop ongoing speech
      const stopSpeech = () => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel(); // Cancel any ongoing speech
        }
      };

      const handleSubmit = async () => {
        if (!query.trim()) {
          setError('Please enter a query.');
          return;
        }
        setLoading(true);
        setError('');
        stopSpeech(); // Stop any ongoing speech before new request
        try {
          const res = await fetch('http://localhost:8000/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });
          if (!res.ok) throw new Error('Failed to fetch response.');
          const data = await res.json();
          setResponse(data.output);
          speak(data.output); // Speak the new response
        } catch (error) {
          setError('Error: ' + error.message);
          setResponse('');
        }
        setLoading(false);
      };

      const startSpeechRecognition = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          setError('Speech recognition not supported in this browser.');
          return;
        }
        stopSpeech(); // Stop any ongoing speech before starting recognition
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          setQuery(transcript);
          handleSubmit();
        };
        recognition.onerror = (event) => {
          setError('Speech recognition error: ' + event.error);
        };
        recognition.start();
      };

      const speak = (text) => {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          window.speechSynthesis.speak(utterance);
        } else {
          setError('Text-to-speech not supported in this browser.');
        }
      };

      return (
        <div className="container mx-auto p-4 max-w-2xl">
          <h1 className="text-3xl font-bold text-center mb-6">AI Scheduling Agent</h1>
          <div className="mb-4">
            <input
              type="text"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="e.g., Schedule a meeting tomorrow at 2pm, cancel event with ID abc123, or list participants for event xyz789"
              className="border p-3 w-full rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled={loading}
            />
            <div className="flex mt-3 space-x-3">
              <button
                onClick={handleSubmit}
                className="flex-1 bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 disabled:bg-blue-300"
                disabled={loading}
              >
                {loading ? 'Processing...' : 'Submit'}
              </button>
              <button
                onClick={startSpeechRecognition}
                className="flex-1 bg-green-500 text-white p-3 rounded-lg hover:bg-green-600"
              >
                Speak Query
              </button>
            </div>
          </div>
          {error && (
            <div className="border p-4 rounded-lg bg-red-100 text-red-700 mb-4">
              <p>{error}</p>
            </div>
          )}
          {response && (
            <div className="border p-4 rounded-lg bg-gray-100 shadow-sm">
              <h2 className="text-lg font-semibold mb-2">Response:</h2>
              <p className="text-gray-800">{response}</p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>